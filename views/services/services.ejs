<% title = 'Services' %>
<div class="max-w-7xl mx-auto">
  <h1 class="text-2xl font-bold mb-6">Your Services</h1>
  <% if (typeof notify !== 'undefined' && notify) { %>
    <div class="mb-4 p-3 rounded <%= notify.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800' %>">
      <%= notify.text %>
    </div>
  <% } %>
  <% 
    function fmtDate(dt) {
      if (!dt) return '';
      const d = new Date(dt);
      if (isNaN(d)) return dt;
      const pad = (n) => String(n).padStart(2, '0');
      const YYYY = d.getFullYear();
      const MM = pad(d.getMonth() + 1);
      const DD = pad(d.getDate());
      const hh = pad(d.getHours());
      const mm = pad(d.getMinutes());
      const ss = pad(d.getSeconds());
      return `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}`;
    }
  %>
  <% if (orders && orders.length) { %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <% orders.forEach(function(o){ %>
        <div class="bg-white p-5 rounded-2xl shadow hover:shadow-lg transition duration-200 flex flex-col justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2"><%= o.server_name %></h3>
            <p class="text-sm text-gray-600 mb-1">Created: <%= o.created_at %></p>
            <% if (o.expires_at || o.expire_date || o.expiry || o.expire) { %>
              <p class="text-sm text-gray-600 mb-1">Expires: <%= fmtDate(o.expires_at || o.expire_date || o.expiry || o.expire) %></p>
            <% } %>
            <p class="text-sm text-gray-600 mb-1">Price: $<%= (o.price || 0).toFixed(2) %></p>
            <p class="text-sm text-gray-600">Status: <span class="font-medium"><%= o.status %></span></p>
          </div>
          <% if (o.ptero_server_id) { %>
            <div class="mt-4 flex gap-2">
              <% if (typeof pteroUrl !== 'undefined' && pteroUrl) { %>
                <% const serverIdent = o.ptero_server_uuid || o.ptero_server_id; %>
                <a href="<%= pteroUrl %>/server/<%= serverIdent %>"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex-1 text-center bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 rounded-lg">
                  Manage
                </a>
              <% } else { %>
                <a href="/"
                   class="flex-1 text-center bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 rounded-lg">
                  Manage
                </a>
              <% } %>
              <form method="post" action="/services/<%= o.id %>/renew" class="flex-1">
                <% if (o.renewAvailable) { %>
                  <button type="submit" class="w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg" onclick="return confirm('Renew this service?')">Renew</button>
                <% } else { %>
                  <button type="button" class="w-full text-center bg-gray-300 text-gray-700 font-medium py-2 rounded-lg" disabled>Renew</button>
                <% } %>
              </form>
            </div>
          <% } else if (o.ptero_response) { %>
            <div class="mt-4 text-sm text-yellow-700 text-center">
              <p>Provisioning in progress...</p>
            </div>
          <% } %>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <p class="text-gray-600">You have no services or orders yet. Visit the <a href="/store" class="text-primary-600 hover:underline">store</a> to order a server.</p>
  <% } %>
</div>
